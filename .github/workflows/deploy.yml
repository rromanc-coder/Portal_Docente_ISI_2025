name: ğŸš€ Deploy Portal Docente ISI 2025

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: ğŸ§© Checkout del repositorio
        uses: actions/checkout@v4

      - name: ğŸ“‚ Sincronizando cÃ³digo con /srv/pln/proyecto_ISI
        run: |
          set -e
          DEPLOY_PATH="/srv/pln/proyecto_ISI"

          echo "ğŸ“‚ Sincronizando cÃ³digo con $DEPLOY_PATH..."
          sudo rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'runner_portal' \
            --exclude 'app/frontend/node_modules' \
            ./ $DEPLOY_PATH/

          cd $DEPLOY_PATH
          echo "ğŸ§¹ Limpiando build/imÃ¡genes previos..."
          sudo docker compose down || true
          # Limpieza profunda de imÃ¡genes y capas
          sudo docker system prune -af || true
          sudo docker volume prune -f || true

          echo "ğŸ” Reconstruyendo imÃ¡genes SIN CACHÃ‰..."
          sudo docker compose build --no-cache

          echo "ğŸš¢ Levantando servicios..."
          sudo docker compose up -d --force-recreate

          echo "âœ… Deploy completado exitosamente."
