name: ğŸš€ Deploy Portal Docente ISI 2025

on:
  push:
    branches: [ "main", "deploy" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    name: ğŸ” Build & Deploy Portal
    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ§¹ Sync to /srv/pln/proyecto_ISI
        run: |
          mkdir -p /srv/pln/proyecto_ISI
          rsync -a --delete $GITHUB_WORKSPACE/ /srv/pln/proyecto_ISI/

      - name: ğŸ³ Rebuild & Restart
        run: |
          cd /srv/pln/proyecto_ISI
          docker compose down -v || true
          docker network create pln_net || true
          docker compose build --no-cache
          docker compose up -d
          docker image prune -f

      - name: âœ… Smoke check
        run: |
          sleep 2
          docker ps | grep proyecto_isi_frontend
